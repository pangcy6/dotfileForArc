class Background{constructor(){this.config={},this.queueProcessorReady=!1,this.uid="",this.version=chrome.runtime.getManifest().version,this.Utils=new Config(this.configLoadCallback()),this.translation=new Translation(this),this.storage=null,this.appWindowId=null,this.run(),this.db_utils=new DatabaseUtils,this.historyStore=null,this.req=null,this.postProcessingComplete=!1,this.version=chrome.runtime.getManifest().version,chrome.browserAction.onClicked.addListener((()=>{this.appWindowId?chrome.windows.update(this.appWindowId,{focused:!0}):-1!==window.navigator.userAgent.indexOf("Windows")?chrome.windows.create(APP_WINDOW_PARAMS_WINDOWS,(e=>{this.appWindowId=e.id})):chrome.windows.create(APP_WINDOW_PARAMS_MAC,(e=>{this.appWindowId=e.id}))}))}run(){this.initStorage(),this.initListeners(),this.translation.createContextMenu()}configLoadCallback(){var e=this;return function(){e.uid=e.Utils.getUserID()}}initStorage(){chrome.storage.local.get((e=>{this.storage=e,e&&e.config&&(this.config=e.config),this.config.uid?this.uid=this.config.uid:(this.uid=this.config.uid=this.generateUID(),this.saveConfig()),this.queueProcessorReady=!0}))}initListeners(){this.initInstalledListeners(),this.initMessageListeners(),this.initWebrequestListeners(),this.initWindowListeners(),this.initStorageListeners()}initInstalledListeners(){chrome.runtime.onInstalled.addListener((e=>{chrome.storage.local.set({time:(new Date).getTime()},(()=>{})),this.checkInstallReason(e.reason)}))}initMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,s)=>{switch(e.action){case"openSettings":this.showSettingsPage(),s("");break;case"updateSettings":this.updateSettingsPage();break;case"openPopup":this.showPopup(),s("");break;case"saveToDatabase":this.trySaveDataToDatabase(e.dataForSaving),s("");break;case"getHistory":this.sendTranslateHistory(s);break;case"clearHistory":this.handleClearHistory();break;case"isAppWindowExists":this.handleAppExistingRequest(s);break;case"removeWindow":this.removeLastFocusedWindow();break;case"updateBadge":this.updateBadge()}return!0}))}saveConfig(){chrome.storage.local.set({config:this.config})}generateUID(){return"xxxxxxxx-xxxx-2xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}updateBadge(){let e=this.storage.popup_mode;chrome.browserAction.setIcon({path:`/images/${e}_icon_badge.svg`})}removeLastFocusedWindow(){chrome.windows.getLastFocused((function(e){"popup"===e.type&&chrome.windows.remove(e.id)}))}showSettingsPage(){const e=chrome.runtime.getURL("html/settings.html");chrome.tabs.query({currentWindow:!0},(t=>{let s=!1,i=null;t.forEach((t=>{t.url===e&&(s=!0,i=t.id)})),s?chrome.tabs.update(i,{highlighted:!0}):chrome.tabs.create({url:e})}))}updateSettingsPage(){chrome.windows.getCurrent((e=>{let t=e.id;chrome.windows.update(t,{focused:!0},(()=>{}));const s=chrome.runtime.getURL("html/settings.html");chrome.tabs.query({windowId:t},(e=>{let t=!1,i=null;e.forEach((e=>{e.url===s&&(t=!0,i=e.id)})),!t||chrome.tabs.reload(i)}))}))}showPopup(e){chrome.browserAction.setPopup({popup:""}),this.appWindowId?chrome.windows.update(this.appWindowId,{focused:!0},(t=>{if(e){const{text:t,callback:s,shortName:i}=e;s(t,i)}})):-1!==window.navigator.userAgent.indexOf("Windows")?chrome.windows.create(APP_WINDOW_PARAMS_WINDOWS,(t=>{if(this.appWindowId=t.id,e){const{text:t,callback:s,shortName:i}=e;s(t,i)}})):chrome.windows.create(APP_WINDOW_PARAMS_MAC,(t=>{if(this.appWindowId=t.id,e){const{text:t,callback:s,shortName:i}=e;s(t,i)}}))}trySaveDataToDatabase(e){this.db_utils.addHistoryItem(e)}sendTranslateHistory(e){this.db_utils.getPartOfRecords().then((t=>e(t))).catch((t=>{e([])}))}handleClearHistory(){this.db_utils.clearStore()}handleAppExistingRequest(e){const t=!!this.appWindowId;e({isAppWindowExist:t}),t&&chrome.windows.update(this.appWindowId,{focused:!0},(e=>{}));const s={active:!0,currentWindow:!t};chrome.tabs.query(s,(e=>{const[t]=e;chrome.tabs.sendMessage(t.id,{action:"getSelectedText"},(e=>{chrome.runtime.sendMessage({action:"selectedText",selectedText:e.selectedText})}))}))}getTl(e){return e.match(/[a-zA-Z]+/)[0]}checkInstallReason(e){let t;"install"===e?(t={tl:this.getTl(chrome.i18n.getUILanguage()),ft:!0,uid:this.Utils.getUserID(),extId:chrome.runtime.id,date_install:(new Date).getTime(),double_click:"double_click_true",icon_trans:"icon_trans_true",popup_mode:"blue",languagesList:[{fullName:this.getTlFullName(),shortName:this.getTl(chrome.i18n.getUILanguage())}],recentLanguages_from:[],recentLanguages_to:[]},this.translation.openUrl("./html/settings.html",!0)):"update"===e&&(t={tl:this.storage.tl,ft:!1,uid:this.Utils.getUserID(),extId:chrome.runtime.id,du:(new Date).getTime(),double_click:"double_click_true",recentLanguages_from:[],recentLanguages_to:[],icon_trans:"icon_trans_true",popup_mode:"blue"}),chrome.storage.local.set(t,(()=>{}))}getTlFullName(){const e=this.getTl(chrome.i18n.getUILanguage());let t=null;return LANGUAGES.forEach((s=>{s.short===e&&(t=s.international)})),t}initWebrequestListeners(){chrome.webRequest.onHeadersReceived.addListener(this.handleIncomingHeaders,{urls:["*://translate.google.com/*"]},["blocking","responseHeaders"]),chrome.webRequest.onBeforeSendHeaders.addListener(this.modifyClientHeaders,{urls:["*://translate.googleapis.com/*"]},["blocking","requestHeaders","extraHeaders"]),chrome.webRequest.onSendHeaders.addListener((e=>{}),{urls:["*://translate.googleapis.com/*"]},["requestHeaders"])}initWindowListeners(){this.initRemoveWindowListeners()}initRemoveWindowListeners(){chrome.windows.onRemoved.addListener((e=>{this.appWindowId===e&&(this.appWindowId=null,chrome.browserAction.setPopup({popup:chrome.runtime.getURL("html/popup.html")}))}))}initStorageListeners(){chrome.storage.onChanged.addListener(((e,t)=>{Object.keys(e).forEach((t=>{this.storage[t]=e[t].newValue,"languagesList"===t&&this.handleMenuListChange()}))}))}handleMenuListChange(){chrome.contextMenus.remove("languagesList",(()=>this.translation.createContextMenu()))}handleIncomingHeaders({responseHeaders:e}){return{responseHeaders:e.filter((e=>"x-frame-options"!==e.name.toLowerCase()))}}modifyClientHeaders({requestHeaders:e}){return{requestHeaders:e.filter((e=>"referer"!==e.name.toLowerCase()))}}}const background=new Background;