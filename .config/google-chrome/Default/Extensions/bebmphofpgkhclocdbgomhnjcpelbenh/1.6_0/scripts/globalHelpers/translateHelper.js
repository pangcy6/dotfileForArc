class TranslateUtils{constructor(t){this.context=t}prepareText(t){return t.replace(/\s{2,}/," ")}getTextChunks(t){const e=t.split(" "),s=[""];for(let t=0,a=e.length,n=0;t<a;++t){let a=s[n]+" "+e[t];a.length<1e3?s[n]=a.trim():(++n,s[n]=e[t])}return s}_saveSentencesParts(t,e,s){s.slice(0,s.length-1).forEach(((s,a)=>{const n=s.orig,r=s.trans;if(0===a&&t.length)return e.push(` ${n}`),void t.push(` ${r}`);e.push(n),t.push(r)}))}_clearSpeechLinks(){Object.keys(this.context.speechLinks).forEach((t=>{this.context.speechLinks[t]=[]}))}translateText(t,e,s){let a=[];this._clearSpeechLinks();const n=e=>{$.ajax({url:"https://translate.googleapis.com/translate_a/single?dt=t&dt=bd&dt=qc&dt=rm&dt=ex",type:"GET",dataType:"json",headers:{Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"},data:{client:"gtx",hl:i||this.context.storage.tl,sl:r||"auto",tl:i||this.context.storage.tl,q:t[e],dj:1},success:t=>{if(a.push(t),s&&!c&&(c=!0,s(t)),h.chunksBuffer.push(t),l++,!t.dict&&t.sentences&&this._saveSentencesParts(h.translatedChunks,h.initialChunks,t.sentences),l<o)return n(l);l==o&&this.context.showTranslatedTextChunk(a),"auto"!==h.translate_from&&this.trySaveRequestToHistory(h);let e=h.chunksBuffer[0].ld_result.srclangs[0],r={fullName:this.getLangFullName(e),shortName:e};this._transformRecentList(r,"recentLanguages_from"),this.initStorage().then((()=>{if(this.storage.recentLanguages_from.length){$(".translation-controls__translate-from").text("").text(this.storage.recentLanguages_from[0].fullName);let t=chrome.runtime.getURL(`images/flags/${this.storage.recentLanguages_from[0].shortName}@2x.png`),e=document.getElementsByClassName("fromTranslation")[0];e&&e.setAttribute("src",t)}})),h=null},error:t=>{}})},{translate_from:r,translate_to:i}=e,o=t.length;let l=0,h={translate_from:r||"auto",translate_to:i||this.context.storage.tl,chunksBuffer:[],initialChunks:[],translatedChunks:[]},c=!1;n(l)}_transformRecentList(t,e){const s=this.context.storage[e],{fullName:a}=t;if(s.length)if(s.length===this.context.max_recent_languages_amount){const n=this._getLangExistData(s,a);if(n.exist)return void this._replaceLanguagesInList(t,e,s,n.index);s.unshift(t),s.splice(s.length-1,1)}else{const n=this._getLangExistData(s,a);if(n.exist)return void this._replaceLanguagesInList(t,e,s,n.index);this._addLangToListAndSave(t,e,s)}else this._addLangToListAndSave(t,e,s)}_addLangToListAndSave(t,e,s){s.unshift(t),this.context.utils_popup&&this.context.utils_popup.saveToStorage({[e]:s})}_getLangExistData(t,e){let s={exist:!1};for(let a=0;a<t.length;a++)if(t[a].fullName===e){s.exist=!0,s.index=a;break}return s}_replaceLanguagesInList(t,e,s,a){const n=s[0];s[0]=t,s[a]=n,this.context.utils_popup&&this.context.utils_popup.saveToStorage({[e]:s})}initStorage(){return new Promise((t=>{chrome.storage.local.get((e=>{this.storage=e,t()}))}))}getTl(t){return t.match(/[a-zA-Z]+/)[0]}getLangFullName(t){let e;return LANGUAGES.forEach((s=>{s.short===t&&(e=s.international)})),e}getTlFullName(){const t=this.getTl(chrome.i18n.getUILanguage());return this.getLangFullName(t)}_getHash(t){const e=t.toLowerCase();let s,a,n=0;for(s=0;s<e.length;s++)a=e.charCodeAt(s),n=(n<<5)-n+a,n|=0;return n}trySaveRequestToHistory(t){if(!t)return;let e,s,{translate_from:a,translate_to:n,chunksBuffer:r,initialChunks:i,translatedChunks:o}=t;i.length?(e=i.join(" "),s=o.join(" ")):(e=r[0].sentences[0].orig,s=r[0].sentences[0].trans),"auto"===a&&(a=r[0].src);const l={translate_from:a,translate_to:n,initialText:e,translatedText:s,timestamp:null,hashCode:null,id:null};l.hashCode=this._getHash(JSON.stringify(l)),l.timestamp=Date.now(),l.id=Math.floor(5e3*Math.random()),chrome.runtime.sendMessage({action:"saveToDatabase",dataForSaving:l})}translateTextAndPerformAction(t,e){this.translateText(t.textChunks,t,e)}}