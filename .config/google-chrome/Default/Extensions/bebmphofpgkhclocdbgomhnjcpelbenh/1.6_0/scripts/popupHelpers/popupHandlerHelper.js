class PopupHandlers{constructor(t){this.context=t,this.bindMethods()}bindMethods(){this.handleTranslateLangChecking=this.handleTranslateLangChecking.bind(this),this.handleTranslateSwapLang=this.handleTranslateSwapLang.bind(this),this.handlePinClick=this.handlePinClick.bind(this),this.handleTranslateTextClick=this.handleTranslateTextClick.bind(this),this.handleBackClick=this.handleBackClick.bind(this),this.handleLanguageSelect=this.handleLanguageSelect.bind(this),this.handleRecentLanguagesClick=this.handleRecentLanguagesClick.bind(this),this.handleSettingsClick=this.handleSettingsClick.bind(this),this.handleShowHistory=this.handleShowHistory.bind(this),this.handleTranslatePage=this.handleTranslatePage.bind(this),this.handleInitTextInput=this.handleInitTextInput.bind(this),this.handleDetectLanguage=this.handleDetectLanguage.bind(this),this.handleClearHistory=this.handleClearHistory.bind(this),this.closePopup=this.closePopup.bind(this),this.handleHistoryItemClick=this.handleHistoryItemClick.bind(this),this.handleDocumentKeyUp=this.handleDocumentKeyUp.bind(this),this.handleControlButton=this.handleControlButton.bind(this)}_fillRecentLanguages(t,e){let a=this.context.storage.popup_mode;if(this.context.$recentLanguages.html(""),e){const t=`\n                <li class="select-language__item ${a} select-language__detect-lang" data-short_name="detect"><img src="${chrome.runtime.getURL(`images/flags/detect_${a}@2x.png`)}"/><span>Detect language</span></li>\n            `;this.context.$recentLanguages.append(t)}t.forEach((t=>{let e=chrome.runtime.getURL(`images/flags/${t.shortName}@2x.png`);const s=`\n                <li class="select-language__item ${a}" data-short_name="${t.shortName}"><img src="${e}"/><span>${t.fullName}</span></li>\n            `;this.context.$recentLanguages.append(s)}))}handleTranslateLangChecking(t){const e=t.currentTarget.classList.contains("translation-controls__translate-from")?"translateFrom":"translateTo",{recentLanguages_from:a,recentLanguages_to:s}=this.context.storage;"translateFrom"===e?(this.context.$detectLanguage.removeClass("hidden_translate"),this._fillRecentLanguages(a,true)):(this.context.$detectLanguage.addClass("hidden_translate"),this._fillRecentLanguages(s)),this.context.$selectLanguageBox.attr("data-status",e),this.context.$selectLanguageBox.removeClass("hidden_translate")}handleTranslateSwapLang(){"detect"!==$(".translation-controls__translate-from").attr("data-request_name")&&this.initStorage().then((()=>{let t=this.storage.recentLanguages_from[0]||{fullName:this.getTlFullName(),shortName:this.getTl(chrome.i18n.getUILanguage())},e=this.storage.recentLanguages_to[0]||{fullName:this.getLangFullName(this.storage.tl),shortName:this.storage.tl};this.storage.recentLanguages_from&&(this.storage.recentLanguages_from.shift(),this.storage.recentLanguages_from.unshift(e)),this.storage.recentLanguages_to&&(this.storage.recentLanguages_to.shift(),this.storage.recentLanguages_to.unshift(t)),chrome.storage.local.set({recentLanguages_from:this.storage.recentLanguages_from,recentLanguages_to:this.storage.recentLanguages_to},(()=>{})),this.setAfterSwapData(e,t)}))}setAfterSwapData(t,e){let a=chrome.runtime.getURL(`images/flags/${t.shortName}@2x.png`),s=chrome.runtime.getURL(`images/flags/${e.shortName}@2x.png`);if(this.context.$translateFromBtn.text(t.fullName),this.context.$translateFromBtn.attr("data-request_name",t.shortName),$("img.fromTranslation")[0].src=a,this.context.$translateToBtn.text(e.fullName),this.context.$translateToBtn.attr("data-request_name",e.shortName),$("img.toTranslation")[0].src=s,$("textarea.textareaView").length){let t=$(".textareaView").val(),e=$(".translation__init-text").val();return $(".translation__init-text").val(""),$(".translation__init-text").val(t),$(".textareaView").val(""),void $(".textareaView").val(e)}let n=$(".main-word").text();$(".main-word").css({"font-weight":"normal","font-size":"17px"});let r=$(".translation__init-text").val();$(".translation__init-text").val(""),$(".translation__init-text").val(n),$(".main-word").text(""),$(".main-word").text(r),$(".main-word").css({"font-weight":"normal","font-size":"17px"}),$(".translit").text(""),$(".translated-categories").html("")}getTl(t){return t.match(/[a-zA-Z]+/)[0]}getLangFullName(t){let e;return LANGUAGES.forEach((a=>{a.short===t&&(e=a.international)})),e}getTlFullName(){const t=this.getTl(chrome.i18n.getUILanguage());return this.getLangFullName(t)}prepareTranslateData(t){t=t||this.context.$translationInitText.val();const e=this._prepareText(t);if(!e)return t;return{textChunks:this.context.utils_translate.getTextChunks(e),requestData:{translate_to:this.context.$translateToBtn.attr("data-request_name"),translate_from:this.context.$translateFromBtn.attr("data-request_name")}}}handleTranslateTextClick(t){this._clearResultFields();const{textChunks:e,requestData:a}=this.prepareTranslateData();this.context.utils_translate.translateText(e,a)}_hideInitTextControlButtons(){this.context.$initTextControls.addClass("hidden_translate")}_showInitTextControlButtons(){this.context.$initTextControls.removeClass("hidden_translate")}handleInitTextInput(t){if(!t.target.value)return this._hideInitTextControlButtons(),void this._clearResultFields();this._showInitTextControlButtons()}handleDetectLanguage(){const t=this._prepareText(this.context.$translationInitText.val());if(t){const e=this.prepareTranslateData(t);this.context.utils_translate.translateTextAndPerformAction(e,(t=>{const e=t.ld_result.srclangs[0],a=e,s=this.context.getLangFullName(e);this.context.$translateFromBtn.attr("data-request_name",a),this.context.$translateFromBtn.text(s);let n=chrome.runtime.getURL(`images/flags/${a}@2x.png`);document.getElementsByClassName("fromTranslation")[0].setAttribute("src",n),this.context.$selectLanguageBox.addClass("hidden_translate"),this.context.$initTextControls.removeClass("hidden_translate"),this.handleTranslateTextClick()}))}else this.context.$selectLanguageBox.addClass("hidden_translate")}_prepareText(t){return t.replace(/^(\s)+/,"").replace(/(\s)+$/,"").replace(/\s{2,}/," ")}_clearResultFields(){this.context.$translationWords.html(""),this.context.$translationSentences.html("")}handlePinClick(t){chrome.runtime.sendMessage({action:"openPopup"}),window.close()}handleBackClick(t){this.context.$selectLanguageBox.addClass("hidden_translate")}_getLangExistData(t,e){let a={exist:!1};for(let s=0;s<t.length;s++)if(t[s].fullName===e){a.exist=!0,a.index=s;break}return a}_replaceLanguagesInList(t,e,a,s){const n=a[0];a[0]=t,a[s]=n,this.context.utils_popup.saveToStorage({[e]:a})}_addLangToListAndSave(t,e,a){a.unshift(t),this.context.utils_popup.saveToStorage({[e]:a})}_transformRecentList(t,e){const a=this.context.storage[e],{fullName:s}=t;if("detect"!==t.shortName)if(a.length)if(a.length===this.context.max_recent_languages_amount){const n=this._getLangExistData(a,s);if(n.exist)return void this._replaceLanguagesInList(t,e,a,n.index);a.splice(-1,1),this._addLangToListAndSave(t,e,a)}else{const n=this._getLangExistData(a,s);if(n.exist)return void this._replaceLanguagesInList(t,e,a,n.index);this._addLangToListAndSave(t,e,a)}else this._addLangToListAndSave(t,e,a)}_getLangNeededData(t){const e=t.target.closest("li");return{isStatusTranslateFrom:"translateFrom"===e.closest(".select-language").dataset.status,textContent:e.textContent.trim()}}_changeTranslateButtonText(t,e){let a,s,n=this.context.storage.popup_mode;"detect"===e.shortName?(a=chrome.runtime.getURL(`images/flags/${e.shortName}_${n}@2x.png`),s=chrome.runtime.getURL(`images/flags/${e.shortName}_${n}@2x.png`)):(a=chrome.runtime.getURL(`images/flags/${e.shortName}@2x.png`),s=chrome.runtime.getURL(`images/flags/${e.shortName}@2x.png`));let{isStatusTranslateFrom:r,textContent:i}=this._getLangNeededData(t);"Detect language"===i&&(i=i.slice(0,6)),r?(this.context.$translateFromBtn.text(i).slice(0,6),this.context.$translateFromBtn.attr("data-request_name",e.shortName),$("img.fromTranslation")[0].src=a):(this.context.$translateToBtn.text(i),this.context.$translateToBtn.attr("data-request_name",e.shortName),$("img.toTranslation")[0].src=s),this.context.$selectLanguageBox.addClass("hidden_translate")}handleLanguageSelect(t){const{textContent:e,isStatusTranslateFrom:a}=this._getLangNeededData(t),s={fullName:e,shortName:t.target.closest("li").dataset.short_name};this._changeTranslateButtonText(t,s),a?this._transformRecentList(s,"recentLanguages_from"):this._transformRecentList(s,"recentLanguages_to")}handleRecentLanguagesClick(t){const e={fullName:t.target.closest("li").textContent,shortName:t.target.closest("li").getAttribute("data-short_name")};this._changeTranslateButtonText(t,e)}handleSettingsClick(t){this.context.$settingsBlock.removeClass("hidden_translate"),$(".container").hide(),$(".history-screen").hide(),$(".settings-block").show(),$("body.popup-mode").css({padding:"20px 30px"})}_renderHistory(t){let e;chrome.storage.local.get((a=>{this.storage=a;const s=t.sort(((t,e)=>e.timestamp-t.timestamp)),n=this.context.$historyScreenPreloader;e="gray"===this.storage.popup_mode||"black"===this.storage.popup_mode?chrome.runtime.getURL(`images/arrow_to_bottom_${this.storage.popup_mode}.svg`):chrome.runtime.getURL("images/arrow_to_bottom.svg"),n.hasClass("hidden_translate")&&n.removeClass("hidden_translate"),s.forEach((t=>{let{translate_from:a,translate_to:s,initialText:n,translatedText:r,id:i}=t;n.length>=50&&(n=n.slice(0,40)+"..."),r.length>=50&&(r=r.slice(0,40)+"...");let o=chrome.runtime.getURL(`images/flags/${a}@2x.png`),l=chrome.runtime.getURL(`images/flags/${s}@2x.png`);const c=`\n                    <li class="history-screen__translated-item">\n                        <div class="history-screen__translate-info">\n                            <div class="translate-icons">\n                                <div class="wrapper_icons">\n                                    <img class="from" src="${o}" data-request_name="${a}" />\n                                    <img class="arrow" src="${e}" />\n                                    <img class="to" src="${l}" data-request_name="${s}" />\n                                </div>\n                            </div>\n                        </div>\n                        <div class="wrapper_data">\n                            <div class="history-screen__initial-text" data-request_code="${i}">${n}</div>\n                            <div class="history-screen__translated-text">${r}</div>\n                        </div>\n                    </li>\n                    <div class="horiz_line"></div>\n                `;this.context.$historyScreenList.append(c),"gray"===this.storage.popup_mode&&($(".history-screen__translated-item .wrapper_icons").css("background","#192330"),$(".horiz_line").css("background","#1A1A1A"),$(".history-screen__translated-item .wrapper_data").css("color","#FFF")),"black"===this.storage.popup_mode&&($(".history-screen__translated-item .wrapper_icons").css("background","#1A1A1A"),$(".horiz_line").css("background","#606060"),$(".history-screen__translated-item .wrapper_data").css("color","#FFF")),n.length<=50&&$(".wrapper_data").css({"justify-content":"center"})})),n.addClass("hidden_translate")}))}handleShowHistory(t){$(".settings-block").hide(),$(".history-screen").show(),$("body.popup-mode").css({padding:"20px 30px"}),$(".history-screen__list").html(""),chrome.runtime.sendMessage({action:"getHistory"},(t=>{this.context.$historyScreen.removeClass("hidden_translate"),this._renderHistory(t)}))}handleTranslatePage(t){const e={active:!0,currentWindow:"openedPopup"!==window.name};this.initStorage().then((()=>{const t=$(".translation-controls__translate-to").attr("data-request_name");chrome.tabs.query(e,(e=>{const a=e[0].id,s=new URL(e[0].url);s.searchParams.append("_x_tr_sl","auto"),s.searchParams.append("_x_tr_tl",t),s.searchParams.append("_x_tr_pto","wapp"),s.searchParams.append("_x_tr_hl","uk"),s.hostname=s.hostname.replace(/\./g,"-")+".translate.goog",chrome.tabs.update(a,{url:s.toString()},(()=>{}))}))}))}initStorage(){return new Promise((t=>{chrome.storage.local.get((e=>{this.storage=e,t()}))}))}handleHistoryItemClick(t){const e=this.context;let a=t.currentTarget.querySelector("img.from").getAttribute("data-request_name");let s=t.currentTarget.querySelector("img.to").getAttribute("data-request_name"),n=chrome.runtime.getURL(`images/flags/${a}@2x.png`),r=chrome.runtime.getURL(`images/flags/${s}@2x.png`);e.$translateFromBtn.text(e.getLangFullName(a)),e.$translateToBtn.text(e.getLangFullName(s)),e.$translateFromBtn.attr("data-request_name",a),e.$translateToBtn.attr("data-request_name",s),document.getElementsByClassName("toTranslation")[0].setAttribute("src",r),document.getElementsByClassName("fromTranslation")[0].setAttribute("src",n),$("img.toTranslation").attr("data-request_name",s),$("img.fromTranslation").attr("data-request_name",a);let i=t.currentTarget.querySelector(".history-screen__initial-text").getAttribute("data-request_code");chrome.runtime.sendMessage({action:"getHistory"},(a=>{let s=a.filter((t=>t.id===+i)),n=s[0].initialText;e.$translationInitText.val(n);const r={sentences:[{trans:s[0].translatedText}]},o=e.generateSentencesLayout(r);e.$translationSentences.html(o),e.$translationWords.html(""),e.$initTextControls.removeClass("hidden_translate"),t.target.closest(".history-screen").classList.add("hidden_translate"),$(".container").show(),$(".popup-mode").css({padding:0})}))}handleClearHistory(t){this.context.$historyScreenList.text(""),chrome.runtime.sendMessage({action:"clearHistory"})}closePopup(){chrome.runtime.sendMessage({action:"updateSettings"}),chrome.runtime.sendMessage({action:"removeWindow"}),chrome.runtime.sendMessage({action:"updateBadge"});chrome.tabs.query({active:!0,currentWindow:!0},(t=>{const e=t[0].id;chrome.tabs.sendMessage(e,{action:"reloadPage"})})),window.location.reload()}handleDocumentKeyUp(t){if(13===t.keyCode&&t.shiftKey)return;return 13===t.keyCode&&this.context.$translationInitText.is(":focus")?(t.preventDefault(),this.handleDetectLanguage(),!1):void 0}_clearText(t){this.context.$translationInitText.val(""),this._clearResultFields(),this._hideInitTextControlButtons(),this.context.audio_utils.stopSpeech()}_copyTextToClipboard(t){const e=document.createElement("input");e.style.position="fixed",e.style.opacity=0,e.value=t,document.body.appendChild(e),e.select(),document.execCommand("Copy"),document.body.removeChild(e)}_copyText(t){const e=t.target.closest(".sound-anchor").querySelector(".word-text").textContent;if(t.target.classList.contains("copied"))return;const a=this.context.$translationResultField.find(".copied");a.length&&a.removeClass("copied"),this._copyTextToClipboard(e),t.target.classList.add("copied")}_soundText(t){const e=t.target;if(e.closest(".translation__init-text-wrapper")){const t=this.context.$translateFromBtn.attr("data-request_name"),e=this._prepareText(this.context.$translationInitText.val());if(!e||!t)return;return void this.context.audio_utils.speechText({text:e,lang:t})}const a=this.context.$translateToBtn.attr("data-request_name"),s=this._prepareText(e.closest(".sound-anchor").querySelector(".word-text").textContent);s&&a&&this.context.audio_utils.speechText({text:s,lang:a})}handleControlButton(t){const e=t.target;e.classList.contains("clear-text")?this._clearText():e.classList.contains("sound-text")?this._soundText(t):e.classList.contains("copy-text")&&this._copyText(t)}}