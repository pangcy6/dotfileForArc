class Popup{constructor(){this.max_recent_languages_amount=5,this.$body=$("body"),this.$openSettings=$(".settings-button"),this.$pinIcon=$(".pin-button"),this.$translateFromBtn=$(".translation-controls__translate-from"),this.$translateToBtn=$(".translation-controls__translate-to"),this.$translateSwapBtn=$(".translation-controls__translation-icon"),this.$translationInitText=$(".translation__init-text"),this.$initTextControls=$(".translation__init-text-btns"),this.$btnClearInitText=$(".translation__clear-init"),this.$btnSoundInitText=$(".translation__sound-init"),this.$detectLanguage=$(".select-language__detect-lang"),this.$section=$("section.section"),this.$translationResultField=$(".translation__result-text"),this.$translationWords=$(".translation__words"),this.$translationSentences=$(".translation__sentences"),this.$translationButton=$(".translation__button"),this.$selectLanguageBox=$(".select-language"),this.$recentLanguages=$(".select-language__recent-list"),this.$languagesList=$(".select-language__list"),this.$backBtn=$(".select-language__back"),this.$settingsBlock=$(".settings-block"),this.$closeSettingsBtn=$(".settings-block__close"),this.$historyScreen=$(".history-screen"),this.$historyScreenPreloader=$(".history-screen__preloader"),this.$historyScreenList=$(".history-screen__list"),this.$historyBtn=$(".history-button"),this.$pageTranslator=$(".page-translator"),this.$historyList=$(".history-screen__list"),this.$clearHistory=$(".history-screen__clear-history"),this.$closePopup=$("#btn_settings_save"),this.$container=$(".container"),this.$header=$(".header.background"),this.$translationControls=$(".translation-controls"),this.$translationControlsWrapper=$(".translation-controls .wrapper_data"),this.$btnClear=$(".btn_clear"),this.$btnSave=$(".btn_save"),this.$selectedLanguagesDelete=$(".selected-languages__delete"),this.audio_utils=new AudioUtils(this),this.audioElement=null,this.speechLinks={originLangLinks:[],targetLangLinks:[]},this.utils_popup=new PopupUtils(this),this.utils_translate=new TranslateUtils(this),this.handlers=new PopupHandlers(this),this.announcementConfig=[{id:"1111",title:"",message:'If you like Translator please take a minute and rate it on <a href="https://chrome.google.com/webstore/detail/translator/bebmphofpgkhclocdbgomhnjcpelbenh/reviews" target="_blank" tabindex="-1">Chrome Web Store</a>',dateFrom:"2021-02-24",dateTo:"2031-12-31",fromInstall:6}],this.initialState={date:new Date,installationDate:new Date,usedIds:[]},this.run()}run(){this.initStorage().then((()=>{this.fetchAnnouncements(),this.checkWindowName(),this.createAudio(),this.utils_popup.fillLanguagesList()}))}loadStorage=t=>{this.storage.load("announcements",[],(e=>{this.initialState.usedIds=e,t()}))};saveUserId=t=>{this.initialState.usedIds.push(t),this.storage.save("announcements",this.initialState.usedIds)};onInstalled=()=>{this.initialState.installationDate=new Date,this.storage.save("installation-date",this.initialState.installationDate)};readStorage=()=>{this.storage.load("installation-date",null,(t=>{t?this.initialState.installationDate=new Date(t):this.onInstalled()}))};attachListener=()=>{document.addEventListener("click",(t=>{const e=t.target.closest(".announcement-close");if(e){const t=e.dataset.id;this.saveUserId(t),document.querySelector(".announcement").style.display="none",document.querySelector("html").style.minHeight="auto"}}))};displayAnnouncement=t=>{let{color:e,mode:n}=this.defineCurrentColor();if(document.querySelector(".announcement").style.display="block",document.querySelector(".announcement").classList.add("is-active"),document.querySelector(".announcement-close").dataset.id=t.id,document.querySelector(".announcement-title").innerHTML=t.title,document.querySelector(".announcement-message").innerHTML=t.message,document.querySelector(".announcement-wrapper").style.background=e,"gray"===n||"black"===n){let t="#FFF";document.querySelector(".announcement-message").style.color=t}if("blue"===n){let t="#FFF";document.querySelector(".announcement-message a").style.color=t}};fetchAnnouncements=()=>{this.announcements.init((()=>{const t=this.announcements.getAnnouncement(this.announcementConfig);t&&this.displayAnnouncement(t)}))};checkWindowName(){"openedPopup"===window.name&&this.$pinIcon.addClass("hidden_translate")}createAudio(){const t=document.createElement("audio");t.className="audio-element",this.audioElement=t,this.audioElement.src="",document.body.insertAdjacentElement("afterbegin",t)}initStorage(){return new Promise((t=>{chrome.storage.local.get((e=>{this.storage=e,this.storage.save=(t,e,n=(()=>{}))=>{const s={[t]:JSON.stringify(e)};chrome.storage.local.set(s,n)},this.storage.load=(t,e,n=(()=>{}))=>{const s={[t]:JSON.stringify(e)};chrome.storage.local.get(s,(e=>{n(JSON.parse(e[t]))}))},this.initAnnouncements(),this.markCheckedElements(),this.initListeners(),this.setCurrentModeView(this.storage.popup_mode),t()}))}))}defineCurrentColor(){let t,e,n,s,a;return s=this.storage.popup_mode,"aquamarine"===s?(t="#02B0B1",e="#049B97",n="#EDF4F3",a="#02A4B5"):"blue"===s?(t="#3771DF",e="#3762CF",n="#EDF2F7",a="#3768F3"):"green"===s?(t="#55B85E",e="#489B4F",n="#F5F8F7",a="#6AC172"):"violet"===s?(t="#5E4FA2",e="#5E4496",n="#F7F7F9",a="#5E40B5"):"pink"===s?(t="#EA6CA4",e="#EA5E98",n="#EAF4F5",a="#EA61AC"):"yellow"===s?(t="#FBBC4A",e="#FBAF42",n="#F6F6F6",a="#FBB352"):"red"===s?(t="#E95A55",e="#E9464B",n="#F4F4F8",a="#E95049"):"gray"===s?(t="#192330",e="#21303F",n="#21303F",a="#21303F"):"black"===s&&(t="#1A1A1A",e="#000",n="#2F2F2F",a="#000"),{color:t,colorDark:e,colorLight:n,colorForButtons:a,mode:s}}setCurrentModeView(t){let{color:e,colorDark:n,colorLight:s,colorForButtons:a}=this.defineCurrentColor();if(chrome.browserAction.setIcon({path:`/images/${t}_icon_badge.svg`}),this.$historyScreen.css("background",s),this.$section.css("background",s),$("body.popup-mode").css("background",s),this.$header.css("background",e),this.$translationControls.css("background",e),this.$translationControlsWrapper.css("background",n),this.$translationButton.css("background",a),this.$btnClear.css("background",a),$(`#${t}`).attr("checked",!0),$(".select-language").css("background",s),$(".form-switch .form-check-input").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/circle_${t}.svg')`),$(".sound-text").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/sound_${t}.svg')`),"gray"===t||"black"===t){let e=chrome.runtime.getURL(`images/triangle_left_${t}.svg`);$(".header span.pin-button").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/pin_btn_${t}.svg')`),$(".header button.history-button").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/history_${t}.svg')`),$(".header span.settings-button").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/settings_${t}.svg')`),$(".triangle.translation-controls__translate-from")[0].src=e,$(".triangle.translation-controls__translate-to")[0].src=e,$(".translation-controls__translation-icon").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/sort_to_${t}.svg')`),$(".translation__init-text").css("color","#FFF"),$(".translation__words").css("color","#FFF"),$(".control-btns .clear-text").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/close_btn_${t}.svg')`),$(".settings-block__close").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/arrow_back_${t}.svg')`),$(".select-language__back").css("background-image",`url('chrome-extension://${chrome.runtime.id}/images/arrow_back_${t}.svg')`)}"gray"===t&&($(".header h1.app-title").css("color","#7F94A0"),$(".translation-controls__translate-from, .translation-controls__translate-to").css("color","#7F94A0"),$(".translation__init-text-wrapper").css("background","#121E26"),$(".translation__init-text").css("background","#121E26"),$(".translation__result-text").css("background","#121E26"),$(".translation .btns_wrapper button.translation__button").css("color","#61707A"),$(".translation .btns_wrapper button.page-translator").css("color","#5E7179"),$(".translation .btns_wrapper button.page-translator").css("border","2px solid #62747C"),$(".history-screen__info").css("background","#192330"),this.$btnClear.css("color","#61707A"),$(".select-language h1,.select-language h2").css("color","#7F93A0"),this.$translationButton.css("background","#121E26")),"black"===t&&($(".header h1.app-title").css("color","#919295"),$(".translation-controls__translate-from, .translation-controls__translate-to").css("color","#919295"),$(".translation__init-text-wrapper").css("background","#000"),$(".translation__init-text").css("background","#000"),$(".translation__result-text").css("background","#000"),$(".translation .btns_wrapper button.translation__button").css("color","#919295"),$(".translation .btns_wrapper button.page-translator").css("color","#919295"),$(".translation .btns_wrapper button.page-translator").css("border","2px solid #919295"),$(".history-screen__info").css("background","#1A1A1A"),this.$btnClear.css("color","#919295"),$(".select-language h1,.select-language h2").css("color","#666"))}initAnnouncements(){this.announcements={init:t=>{this.readStorage(),this.loadStorage(t),this.attachListener()},getAnnouncement:t=>t.filter((t=>this.initialState.date>=new Date(t.dateFrom))).filter((t=>this.initialState.date<=new Date(t.dateTo))).filter((t=>-1===this.initialState.usedIds.indexOf(t.id))).filter((t=>t.fromInstall<=Math.floor((this.initialState.date-this.initialState.installationDate)/1e3/60/60/23))).pop()}}markCheckedElements(){this.markTranslateLanguages()}markTranslateLanguages(){let t,e;const{recentLanguages_from:n,recentLanguages_to:s}=this.storage;let a=n[0],o=s[0];if(a?t=chrome.runtime.getURL(`images/flags/${a.shortName}@2x.png`):(a={fullName:"Detect",shortName:"detect"},t=chrome.runtime.getURL(`images/flags/${a.shortName}_${this.storage.popup_mode}@2x.png`)),!o){let t=this.storage.tl;o={fullName:this.getLangFullName(t),shortName:t}}e=chrome.runtime.getURL(`images/flags/${o.shortName}@2x.png`),this.$translateFromBtn.text(a.fullName),this.$translateFromBtn.attr("data-request_name",a.shortName),this.$translateToBtn.text(o.fullName),this.$translateToBtn.attr("data-request_name",o.shortName),$("img.fromTranslation")[0]&&($("img.fromTranslation")[0].src=t),$("img.fromTranslation").attr("data-request_name",a.shortName),$("img.toTranslation")[0]&&($("img.toTranslation")[0].src=e),$("img.toTranslation").attr("data-request_name",o.shortName)}getTl(t){return t.match(/[a-zA-Z]+/)[0]}getLangFullName(t){let e;return LANGUAGES.forEach((n=>{n.short===t&&(e=n.international)})),e}getTlFullName(){const t=this.getTl(chrome.i18n.getUILanguage());return this.getLangFullName(t)}initListeners(){this.initMessageListeners(),this.initDOMListeners()}initMessageListeners(){chrome.runtime.onMessage.addListener(((t,e,n)=>{switch(t.action){case"selectedText":this.handleIncomingSelectedText(t.selectedText)}}))}handleIncomingSelectedText(t){if(t){const e=this.handlers.prepareTranslateData(t);this.utils_translate.translateTextAndPerformAction(e,(e=>{const n=e.src,s=n,a=this.getLangFullName(n),o=this.getTl(chrome.i18n.getUILanguage()),r=this.getTlFullName();this.$translateFromBtn.attr("data-request_name",s),this.$translateFromBtn.text(a),this.$translateToBtn.attr("data-request_name",o),this.$translateToBtn.text(r),this.$translationInitText.text(t),this.$initTextControls.removeClass("hidden_translate")}))}}initDOMListeners(){$("#btn_settings_save").html(chrome.i18n.getMessage("btn_settings_save")),$("#btn_history_clear").html(chrome.i18n.getMessage("btn_history_clear")),this.$openSettings.on("click",this.handlers.handleSettingsClick),this.$pinIcon.on("click",this.handlers.handlePinClick),this.$translateFromBtn.on("click",this.handlers.handleTranslateLangChecking),this.$translateToBtn.on("click",this.handlers.handleTranslateLangChecking),this.$translateSwapBtn.on("click",this.handlers.handleTranslateSwapLang),this.$translationButton.on("click",this.handlers.handleDetectLanguage),this.$translationInitText.on("input",this.handlers.handleInitTextInput),this.$btnClearInitText.on("click",this.handlers.handleClearText),this.$btnSoundInitText.on("click",this.handlers.handleSpeechText),this.$backBtn.on("click",this.handlers.handleBackClick),this.$languagesList.on("click",".select-language__language",this.handlers.handleLanguageSelect),this.$recentLanguages.on("click",".select-language__item",this.handlers.handleLanguageSelect),this.$closeSettingsBtn.on("click",(t=>{this.$settingsBlock.addClass("hidden_translate"),this.$container.show(),this.$historyScreen.hide(),$("body.popup-mode").css({padding:0})})),this.$historyBtn.on("click",this.handlers.handleShowHistory),this.$pageTranslator.on("click",this.handlers.handleTranslatePage),this.$clearHistory.on("click",this.handlers.handleClearHistory),this.$closePopup.on("click",this.handlers.closePopup),this.$historyList.on("click",".history-screen__translated-item",this.handlers.handleHistoryItemClick),document.addEventListener("keypress",this.handlers.handleDocumentKeyUp),this.$body.on("click",".copy-text, .sound-text, .clear-text",this.handlers.handleControlButton)}generateWordCategoriesLayout(t){let e="";return t.forEach((t=>{e+=`\n                <div class="category">\n                    <h3 class="category__name">${t.pos}</h3>\n                    <div class="category__terms">${t.terms.join(", ")}</div>\n                </div>\n            `})),e}generateWordCategoriesLayout(t){let e="";return t.forEach((t=>{let n=`<h2 class="word-category">${t.pos}</h2>`,s="";t.entry.forEach((t=>{let e=t.reverse_translation;e.length>3&&(e=e.slice(3));let n=`\n                    <div class="translated-word">\n                        <span class="bold word-text">${t.word}</span>\n                        <div class="control-btns">\n                            <span class="sound-text ${this.storage.popup_mode}"></span>\n                            <span class="copy-text ${this.storage.popup_mode}"></span>\n                        </div>\n                    </div>\n                    <span class="reverse-translates"> ${e.join(", ")} </span>`;s+=`<div class="translates sound-anchor">${n}</div>`})),e+=`\n                <div class="translated-category">\n                    ${n+s}\n                </div>`})),e}checkForTranslit(t){let e,n=!1;return t.forEach((t=>{t.hasOwnProperty("translit")&&(n=!0,e=t.translit),t.hasOwnProperty("src_translit")&&(n=!0,e=t.src_translit)})),n?`<div class="translit">${e}</div>`:""}generateWordsLayout(t){return`\n            <div class="main-translate-word sound-anchor">\n                <span class="main-word bold word-text">${t[0].sentences[0].trans}</span>\n                <div class="control-btns">\n                    <span class="sound-text ${this.storage.popup_mode}"></span>\n                    <span class="copy-text ${this.storage.popup_mode}"></span>\n                </div>\n            </div>\n            ${this.checkForTranslit(t[0].sentences)}\n            <div class="translated-categories">${this.generateWordCategoriesLayout(t[0].dict)}</div>\n        `}concatSentencesText(t){let e=[],n=t.length;if(n&&1==n)e=t[0];else if(n)for(let s=0;s<n;s++)e=e.concat(t[s]);let s="";return e.forEach((t=>{t.hasOwnProperty("translit")||t.hasOwnProperty("src_translit")||(s+=t.trans)})),s||""}generateSentencesLayout(t){let e,n;"gray"===this.storage.popup_mode?(n="#121E26",e="#FFF"):"black"===this.storage.popup_mode&&(n="#000",e="#FFF");return`\n            <div class="translated-sentence-wrapper sound-anchor">\n                <textarea class="translated-sentence word-text textareaView" style="background:${n};color:${e}" readonly>${this.concatSentencesText(t)}</textarea>\n                <div class="control-btns-main">\n                    <span class="copy-text ${this.storage.popup_mode}"></span>\n                    <span class="sound-text ${this.storage.popup_mode}"></span>\n                </div>\n            </div>\n        `}showTranslatedTextChunk(t){let e,n=[],s=t.length;if(t[s-1].dict)e=this.generateWordsLayout(t),this.$translationSentences.html(""),this.$translationWords.html(e);else if(t[s-1].sentences){for(let e=0;e<s;e++)n.push(t[e].sentences);e=this.generateSentencesLayout(n),this.$translationWords.html(""),this.$translationSentences.html(e);const a={lang_from:this.$translateFromBtn.attr("data-request_name"),lang_to:this.$translateToBtn.attr("data-request_name")};this.audio_utils.createSentacesSpeechLinks(n,a)}}}$((function(){new Popup}));