let newCoord={};class Content{constructor(){this.storage=null,this.selectedFullObject=null,this.selectBounding=null,this.selectedText=null,this.translateButton=null,this.translateTooltip=null,this.tooltipHeader=null,this.translatedText=null,this.dblClickToggleBtn=null,this.iconTransToggleBtn=null,this.audioElement=null,this.translatedLang=null,this.speechLinks={originLangLinks:[],targetLangLinks:[]},this.translate_utils=new TranslateUtils(this),this.audio_utils=new AudioUtils(this),this.run()}run(){this.initStorage().then((()=>{this.insertDOMElements(),this.bindMethods(),this.initListeners()})).catch((t=>{}))}initStorage(){return new Promise(((t,e)=>{chrome.storage.local.get((e=>{this.storage=e,t()}))}))}insertDOMElements(){this.insertUIElements(),this.createAudio()}insertUIElements(){let t;const{double_click:e,icon_trans:a,popup_mode:n}=this.storage;t="black"===n||"gray"===n?chrome.runtime.getURL(`images/right_arrow_${n}_mode.svg`):chrome.runtime.getURL("images/right-arrow.png");const s=`<span class="translate-button-mtz hidden_translate ${this.storage.popup_mode}"></span>`,i=`<div class="translate-tooltip-mtz ${n} sm-root translate hidden_translate">\n                    <div class="header-wrapper">\n                        <div class="header-controls">\n                            <span class="sound-translate"></span>\n                            <span class="copy ${n}"></span>\n                            <span class="settings-translator"></span>\n                        </div>\n                        <div class="header-title">translator</div>\n                        <div class="translate-icons">\n                            <img class="from" src="" />\n                            <img class="translate-arrow" src="${t}" />\n                            <div class="translate_to_dropdown">\n                                <button class="dropbtn dropdown-toggle" type="button" id="dropdownMenuButton1" aria-expanded="false"></button>\n                                <ul class="dropdown-content-wrapper languageSelector ${n}">\n                                    <li><a class="dropdown-item" data-lang='af'>Afrikaans</a></li>\n                                    <li><a class="dropdown-item" data-lang='sq'>Albanian - shqipe</a></li>\n                                    <li><a class="dropdown-item" data-lang='ar'>Arabic - ‎‫العربية‬‎</a></li>\n                                    <li><a class="dropdown-item" data-lang='hy'>Armenian - Հայերէն</a></li>\n                                    <li><a class="dropdown-item" data-lang='az'>Azerbaijani - azərbaycanca</a></li>\n                                    <li><a class="dropdown-item" data-lang='eu'>Basque - euskara</a></li>\n                                    <li><a class="dropdown-item" data-lang='be'>Belarusian - беларуская</a></li>\n                                    <li><a class="dropdown-item" data-lang='bn'>Bengali - বাংলা</a></li>\n                                    <li><a class="dropdown-item" data-lang='bg'>Bulgarian - български</a></li>\n                                    <li><a class="dropdown-item" data-lang='ca'>Catalan - català</a></li>\n                                    <li><a class="dropdown-item" data-lang='zh-CN'>Chinese - 中文（简体中文）</a></li>\n                                    <li><a class="dropdown-item" data-lang='zh-TW'>Chinese - 中文 (繁體中文)</a></li>\n                                    <li><a class="dropdown-item" data-lang='hr'>Croatian - hrvatski</a></li>\n                                    <li><a class="dropdown-item" data-lang='cs'>Czech - čeština</a></li>\n                                    <li><a class="dropdown-item" data-lang='da'>Danish - dansk</a></li>\n                                    <li><a class="dropdown-item" data-lang='nl'>Dutch - Nederlands</a></li>\n                                    <li><a class="dropdown-item" data-lang='en'>English</a></li>\n                                    <li><a class="dropdown-item" data-lang='eo'>Esperanto - esperanto</a></li>\n                                    <li><a class="dropdown-item" data-lang='et'>Estonian - eesti</a></li>\n                                    <li><a class="dropdown-item" data-lang='tl'>Filipino</a></li>\n                                    <li><a class="dropdown-item" data-lang='fi'>Finnish - suomi</a></li>\n                                    <li><a class="dropdown-item" data-lang='fr'>French - français</a></li>\n                                    <li><a class="dropdown-item" data-lang='gl'>Galician - galego</a></li>\n                                    <li><a class="dropdown-item" data-lang='ka'>Georgian - ქართული</a></li>\n                                    <li><a class="dropdown-item" data-lang='de'>German - Deutsch</a></li>\n                                    <li><a class="dropdown-item" data-lang='el'>Greek - Ελληνικά</a></li>\n                                    <li><a class="dropdown-item" data-lang='gu'>Gujarati - ગુજરાતી</a></li>\n                                    <li><a class="dropdown-item" data-lang='ht'>Haitian Creole - kreyòl ayisyen</a></li>\n                                    <li><a class="dropdown-item" data-lang='iw'>Hebrew - ‎‫עברית‬‎</a></li>\n                                    <li><a class="dropdown-item" data-lang='hi'>Hindi - हिन्दी</a></li>\n                                    <li><a class="dropdown-item" data-lang='hu'>Hungarian - magyar</a></li>\n                                    <li><a class="dropdown-item" data-lang='is'>Icelandic - íslenska</a></li>\n                                    <li><a class="dropdown-item" data-lang='id'>Indonesian - Bahasa Indonesia</a></li>\n                                    <li><a class="dropdown-item" data-lang='ga'>Irish - Gaeilge</a></li>\n                                    <li><a class="dropdown-item" data-lang='it'>Italian - italiano</a></li>\n                                    <li><a class="dropdown-item" data-lang='ja'>Japanese - 日本語</a></li>\n                                    <li><a class="dropdown-item" data-lang='kn'>Kannada - ಕನ್ನಡ</a></li>\n                                    <li><a class="dropdown-item" data-lang='ko'>Korean - 한국어</a></li>\n                                    <li><a class="dropdown-item" data-lang='la'>Latin - Lingua Latina</a></li>\n                                    <li><a class="dropdown-item" data-lang='lv'>Latvian - latviešu</a></li>\n                                    <li><a class="dropdown-item" data-lang='lt'>Lithuanian - lietuvių</a></li>\n                                    <li><a class="dropdown-item" data-lang='mk'>Macedonian - македонски</a></li>\n                                    <li><a class="dropdown-item" data-lang='ms'>Malay - Bahasa Melayu</a></li>\n                                    <li><a class="dropdown-item" data-lang='mt'>Maltese - Malti</a></li>\n                                    <li><a class="dropdown-item" data-lang='no'>Norwegian - norsk</a></li>\n                                    <li><a class="dropdown-item" data-lang='fa'>Persian - ‎‫فارسی‬‎</a></li>\n                                    <li><a class="dropdown-item" data-lang='pl'>Polish - polski</a></li>\n                                    <li><a class="dropdown-item" data-lang='pt'>Portuguese - português</a></li>\n                                    <li><a class="dropdown-item" data-lang='ro'>Romanian - română</a></li>\n                                    <li><a class="dropdown-item" data-lang='ru'>Russian - русский</a></li>\n                                    <li><a class="dropdown-item" data-lang='sr'>Serbian - Српски</a></li>\n                                    <li><a class="dropdown-item" data-lang='sk'>Slovak - slovenčina</a></li>\n                                    <li><a class="dropdown-item" data-lang='sl'>Slovenian - slovenščina</a></li>\n                                    <li><a class="dropdown-item" data-lang='es'>Spanish - español</a></li>\n                                    <li><a class="dropdown-item" data-lang='sw'>Swahili - Kiswahili</a></li>\n                                    <li><a class="dropdown-item" data-lang='sv'>Swedish - svenska</a></li>\n                                    <li><a class="dropdown-item" data-lang='ta'>Tamil - தமிழ்</a></li>\n                                    <li><a class="dropdown-item" data-lang='te'>Telugu - తెలుగు</a></li>\n                                    <li><a class="dropdown-item" data-lang='th'>Thai - ไทย</a></li>\n                                    <li><a class="dropdown-item" data-lang='tr'>Turkish - Türkçe</a></li>\n                                    <li><a class="dropdown-item" data-lang='uk'>Ukrainian - українська</a></li>\n                                    <li><a class="dropdown-item" data-lang='ur'>Urdu - ‎‫اردو‬‎</a></li>\n                                    <li><a class="dropdown-item" data-lang='vi'>Vietnamese - Tiếng Việt</a></li>\n                                    <li><a class="dropdown-item" data-lang='cy'>Welsh - Cymraeg</a></li>\n                                    <li><a class="dropdown-item" data-lang='yi'>Yiddish - יידיש</a></li>\n                            </ul>\n                          </div>\n                        </div>\n                    </div>\n                    <div class="translated-text">\n                        <div id ="translator-words" class="words"></div>\n                        <div class="sentences ${n}"></div>\n                    </div>\n                    <div class="trans_controls">\n                        <div class="trans_controls__control-wrapper double_click">\n                            <span class="trans_controls__toggle dbl-click ${"double_click_true"===e?"active":""}" data-store="double_click">\n                                <div class="trans_controls__inner-circle"></div>\n                            </span>\n                            <span class="trans_controls__description">\n                            Double-click\n                            </span>\n                        </div>\n                        <div class="trans_controls__control-wrapper selection">\n                            <span class="trans_controls__toggle icon-trans ${"icon_trans_true"===a?"active":""}" data-store="icon_trans">\n                                <div class="trans_controls__inner-circle"></div>\n                            </span>\n                            <span class="trans_controls__description">\n                            Select to translate\n                            </span>\n                        </div>\n                    </div>\n                </div>`;document.body.insertAdjacentHTML("afterbegin",s),document.body.insertAdjacentHTML("afterbegin",i)}defineCurrentColor(){let t,e,a,n;return n=this.storage.popup_mode,"aquamarine"===n?(t="#02B0B1",e="#029FA6",a="#F5F8F7"):"blue"===n?(t="#3771DF",e="#3762CF",a="#EDF2F7"):"green"===n?(t="#55B85E",e="#489B4F"):"violet"===n?(t="#5E4FA2",e="#5E4496",a="#F7F7F9"):"pink"===n?(t="#EA6CA4",e="#EA5E98",a="#EAF4F5"):"yellow"===n?(t="#FBBC4A",e="#FBAF42",a="#F6F6F6"):"red"===n?(t="#E95A55",e="#F22035",a="#F4F4F8"):"gray"===n?(t="#192330",e="#121E26",a="#21303F"):"black"===n&&(t="#1A1A1A",e="#000",a="#2F2F2F"),{color:t,colorDark:e,colorLight:a,mode:n}}createAudio(){const t=document.createElement("audio");t.className="audio-for-speech",this.audioElement=t,this.audioElement.src="",document.body.insertAdjacentElement("afterbegin",t)}bindMethods(){this.handleSelection=this.handleSelection.bind(this),this.handleTranslateClick=this.handleTranslateClick.bind(this),this.regulateTooltipVisibility=this.regulateTooltipVisibility.bind(this),this.handleHeaderClick=this.handleHeaderClick.bind(this),this.handletranslatedTextClick=this.handletranslatedTextClick.bind(this),this.handleDblClick=this.handleDblClick.bind(this),this.handleOptionToggling=this.handleOptionToggling.bind(this),this.handleShowOrigin=this.handleShowOrigin.bind(this),this.handleChangeLanguage=this.handleChangeLanguage.bind(this)}initListeners(){this.initMessageListeners(),this.initDOMListeners(),this.initStorageListeners()}checkToggleBtnActuality(t,e){this.storage[e].includes("true")!==t.classList.contains("active")&&t.classList.toggle("active")}initStorageListeners(){chrome.storage.onChanged.addListener((t=>{Object.keys(t).forEach((e=>{this.storage[e]=t[e].newValue,"double_click"===e&&this.checkToggleBtnActuality(this.dblClickToggleBtn,"double_click"),"icon_trans"===e&&this.checkToggleBtnActuality(this.iconTransToggleBtn,"icon_trans")}))}))}initMessageListeners(){chrome.runtime.onMessage.addListener(((t,e,a)=>{switch(t.action){case"showTranslatePopup":this.handleMessageTranslation(t.translateTo);break;case"getSelectedText":this.sendSelectedText(a);break;case"reloadPage":window.location.reload()}return a(""),!0}))}getGoogleTrIframeDoc(){const t=document.getElementById(":0.container");return t?t.contentDocument:null}sendSelectedText(t){t({selectedText:this.selectedText=window.getSelection().toString()})}handleShowOrigin(t){const e=this.getGoogleTrIframeDoc();if(e){e.getElementById(":0.restore").click(),$(".page-translation").hide()}}handleMessageTranslation(t){const e={translate_from:"",translate_to:t};this.selectedText=this.selectedFullObject.toString();const a=this.translate_utils.getTextChunks(this.selectedText);this.translate_utils.translateText(a,e)}initDOMListeners(){document.addEventListener("mouseup",this.handleSelection),document.addEventListener("mousedown",(t=>{this.regulateTooltipVisibility(t),this.regulateTranslateButtonVisibility(t)})),document.addEventListener("dblclick",this.handleDblClick),this.initUIListeners()}initUIListeners(){this.translateButton=document.querySelector(".translate-button-mtz"),this.translateTooltip=document.querySelector(".translate-tooltip-mtz"),this.tooltipHeader=this.translateTooltip.querySelector(".header-wrapper"),this.translatedText=this.translateTooltip.querySelector(".translated-text"),this.dblClickToggleBtn=this.translateTooltip.querySelector(".dbl-click"),this.iconTransToggleBtn=this.translateTooltip.querySelector(".icon-trans"),this.translateButton.addEventListener("mousedown",this.handleTranslateClick),this.tooltipHeader.addEventListener("click",this.handleHeaderClick),this.translatedText.addEventListener("click",this.handleOptionToggling),this.dblClickToggleBtn.addEventListener("click",this.handleOptionToggling),this.iconTransToggleBtn.addEventListener("click",this.handleOptionToggling),this.translatedText.addEventListener("click",this.handletranslatedTextClick),this.tooltipHeader.addEventListener("click",this.handletranslatedTextClick),$(".languageSelector .dropdown-item").on("click",this.handleChangeLanguage),$(".dropbtn").on("click",(()=>{$(".dropdown-content-wrapper").toggle()}))}handleChangeLanguage(t){let e=t.target.getAttribute("data-lang");chrome.storage.local.set({tl:e},(()=>{})),chrome.storage.local.get((t=>{this.storage=t;const e={translate_from:"",translate_to:this.storage.tl},a=this.translate_utils.getTextChunks(this.selectedText);this.translate_utils.translateText(a,e),this.translateTooltip.querySelector(".words").innerHTML="",this.translateTooltip.querySelector(".sentences").innerHTML="",$(".dropdown-content-wrapper").hide(),$(".translate-tooltip-mtz").hide()}))}handleTranslateClick(){const t={translate_from:"",translate_to:this.storage.tl};this.hideElement(this.translateButton),this.selectedText=this.selectedFullObject.toString();const e=this.translate_utils.getTextChunks(this.selectedText);this.translate_utils.translateText(e,t)}handleHeaderClick(t){const e=t.target;e.classList.contains("settings-translator")?this.sendMessage({action:"openSettings"}):e.classList.contains("sound-translate")&&this.speechNativeText()}handleOptionToggling(t){const e=t.currentTarget,a=e.dataset.store;e.classList.toggle("active");const n=e.classList.contains("active");if("double_click"===a){const t=n?"double_click_true":"double_click_false";chrome.storage.local.set({double_click:t},(()=>{}))}else if("icon_trans"===a){const t=n?"icon_trans_true":"icon_trans_false";chrome.storage.local.set({icon_trans:t},(()=>{}))}}speechNativeText(){this.areTranslatedSentences()?this.audio_utils.speechSentences("originLangLinks"):this.audio_utils.speechWord(this.selectedText.trim(),this.translatedLang)}handletranslatedTextClick(t){const e=t.target.classList;let a,n=t.target.closest(".sound-anchor");if(a=n?n.querySelector(".word-text").textContent:this.selectedText.trim(),e.contains("sound"))this.areTranslatedSentences()?this.audio_utils.speechSentences("targetLangLinks"):this.audio_utils.speechWord(a,this.storage.tl);else if(e.contains("copy")){if(e.contains("copied"))return;const t=this.translateTooltip.querySelector(".copied");t&&t.classList.remove("copied"),this.copyTextToClipboard(a),e.add("copied")}}copyTextToClipboard(t){const e=document.createElement("input");e.style.position="fixed",e.style.opacity=0,e.value=t,document.body.appendChild(e),e.select(),document.execCommand("Copy"),document.body.removeChild(e)}regulateTooltipVisibility(t){this.translateButton.classList.contains("hidden_translate")||this.hideElement(this.translateButton),this.translateTooltip.classList.contains("hidden_translate")||t.target.closest(".translate-tooltip-mtz")||(this.hideElement(this.translateTooltip),this.translateTooltip.querySelector(".words").innerHTML="",this.translateTooltip.querySelector(".sentences").innerHTML="",this.audioElement.pause())}regulateTranslateButtonVisibility(t){this.translateButton.classList.contains("hidden_translate")||this.hideElement(this.translateButton)}handleDblClick(t){"double_click_false"!==this.storage.double_click&&this.isSelection()&&(this.isSelectedTextForbidden(t.target.tagName)||(this.hideElement(this.translateButton),this.handleTranslateClick(t)))}handleSelection(t){this.isSelection()&&(this.isSelectedTextForbidden(t.target.tagName)||"icon_trans_false"!==this.storage.icon_trans&&this.showTranslateButton())}isSelectedTextForbidden(t){t=t.toLowerCase();return["input","textarea"].some((e=>e===t))}isSelection(){if(this.selectedFullObject=window.getSelection(),this.selectedFullObject.getRangeAt(0)){const t=this.selectedFullObject.getRangeAt(0);return this.selectBounding=t.getBoundingClientRect(),0!==Math.round(this.selectBounding.width)&&(newCoord=this.selectBounding),!!this.selectedFullObject.toString().trim()}}showTranslateButton(){this.setButtonPosition(),this.showElement(this.translateButton)}setButtonPosition(){const{top:t,left:e}=this.getTranslateButtonPosition(this.selectedFullObject),a={top:t+"px",left:e+"px"};this.applyStylesToElement(this.translateButton,a)}getTranslateButtonPosition(){let t,e=this.selectBounding.left+this.selectBounding.width/2+window.scrollX-12.5;return t=this.selectBounding.top+this.selectBounding.height+10+25>window.innerHeight?this.selectBounding.top-10-25+window.scrollY:this.selectBounding.top+this.selectBounding.height+10+window.scrollY,{top:t,left:e}}showElement(t){const e=t.classList;e.contains("hidden_translate")&&e.remove("hidden_translate")}hideElement(t){const e=t.classList;e.contains("hidden_translate")||e.add("hidden_translate")}applyStylesToElement(t,e){const a=Object.keys(e);let n="";a.forEach((t=>n+=`${t}: ${e[t]};`)),t.setAttribute("style",n)}showTranslatedTextChunk(t,e){let a=[];if(t.length&&1==t.length)a=t[0];else if(t.length)for(let e=0;e<t.length;e++)a=a.concat(t[e].sentences);if($(".copied").removeClass("copied"),this.translatedLang=t[0].src,this.setFlags(this.translatedLang,e),a.dict){let t=this.generateWordsLayout(a);this.translateTooltip.querySelector(".words").innerHTML=t,$(".sentences").css({background:"none"})}else $("#translator-words.words").css({height:0}),$("#translator-words.words").css({padding:0}),this.renderSentences(a),this.audio_utils.createSentacesSpeechLinks(a);this.setTooltipPosition(),this.showElement(this.translateTooltip)}renderSentences(t){if(this.areTranslatedSentences()){this.translateTooltip.querySelector(".translated-sentence").textContent+=this.concatSentencesText(t.sentences);const e=this.translateTooltip.querySelector(".translit");if(!e)return;const a=t.sentences.length-1;e.textContent+=t.sentences[a].translit||t.sentences[a].src_translit}else{const e=this.translateTooltip.querySelector(".sentences");let a=this.generateSentencesLayout(t);e.innerHTML=a}}setFlags(t,e){const a=t,n=e||this.storage.tl;this.translateTooltip.querySelector("img.from").src=chrome.runtime.getURL(`images/flags/${a}@2x.png`);let s=chrome.runtime.getURL(`images/flags/${n}@2x.png`);$(".sm-root button.dropdown-toggle").css("background-image",`url(${s})`)}generateWordsLayout(t){let e=this.storage.popup_mode;return`\n            <div class="main-translate-word sound-anchor">\n                <span class="main-word bold word-text">${t.sentences[0].trans}</span>\n                <div class="buttons">\n                    <span class="copy ${e}"></span>\n                    <span class="sound ${e}"></span>\n                </div>\n            </div>\n            ${this.checkForTranslit(t.sentences)}\n            <div class="translated-categories ${e}">${this.generateWordCategoriesLayout(t.dict)}</div>\n        `}checkForTranslit(t){let e,a=!1;return t.sentences&&(t=t.sentences),t.forEach((t=>{t.hasOwnProperty("translit")&&(a=!0,e=t.translit),t.hasOwnProperty("src_translit")&&(a=!0,e=t.src_translit)})),a?`<div class="translit">${e}</div>`:""}generateSentencesLayout(t){let e=this.storage.popup_mode;return`\n            <div class="translated-sentence-wrapper sound-anchor">\n                <div class="translated-sentence word-text">${this.concatSentencesText(t)}</div>\n                <div class="buttons">\n                    <span class="copy ${e}"></span>\n                    <span class="sound ${e}"></span>\n                </div>\n            </div>\n            ${this.checkForTranslit(t)}\n        `}concatSentencesText(t){t.sentences&&(t=t.sentences);let e="";return t.forEach((t=>{t.hasOwnProperty("translit")||t.hasOwnProperty("src_translit")||(e+=t.trans)})),e||""}setTooltipPosition(){let t,e;const a=370;0==Math.round(this.selectBounding.width)?(t=window.scrollX+newCoord.left+newCoord.width/2-150,t<0&&(t=0),e=window.scrollY+newCoord.top+30,e>document.body.clientHeight-a&&(e=window.scrollY+newCoord.top-a-30)):(t=window.scrollX+this.selectBounding.left+this.selectBounding.width/2-150,t<0&&(t=0),e=window.scrollY+this.selectBounding.top+30,e>document.body.clientHeight-a&&(e=window.scrollY+this.selectBounding.top-a-30));const n={left:t+"px",top:e+"px"};this.applyStylesToElement(this.translateTooltip,n)}generateWordCategoriesLayout(t){let e=this.storage.popup_mode,a="";return t.forEach((t=>{let n=`<h2 class="word-category">${t.pos}</h2>`,s="";t.entry.forEach((t=>{let a=t.reverse_translation;a.length>3&&(a=a.slice(3));let n=`\n                    <div class="translated-word">\n                        <span class="bold word-text">${t.word}</span>\n                        <div class="buttons">\n                            <span class="copy ${e}"></span>\n                            <span class="sound ${e}"></span>\n                        </div>\n                        </div>\n                    <span class="reverse-translates"> ${a.join(", ")} </span>`;s+=`<div class="translates sound-anchor">${n}</div>`})),a+=`\n                <div class="translated-category">\n                    ${n+s}\n                </div>`})),a}sendMessage(t,e=(()=>{})){chrome.runtime.sendMessage(t,e)}areTranslatedSentences(){return!!this.translateTooltip.querySelector(".translated-sentence-wrapper")}}const content=new Content;